# 21장 로깅과 사용추적

### 21.1 로그란 무엇인가?

일반적으로 로깅을 하는 이유

1. 서버나 프락시의 문제를 찾기
2. 웹 사이트 접근 통계 내기

일반적으로 로깅하는 필드

1. HTTP 메서드
2. 클라이언트와 서버의 HTTP 버전
3. 요청받은 리소스의 URL
4. 응답의 HTTP 상태 코드
5. 요청과 응답 메시지의 크기 (모든 엔터티 본문을 포함)
6. 트랜잭션이 일어난 시간
7. Referer와 User-Agent 헤더 값

### 21.2 로그 포맷

상용, 오픈소스 HTTP 애플리케이션들은 대부분 표준 로그 포맷을 지원한다.

표준 로그 포맷을 사용해서 로그를 더 쉽게 관리할 수 있다.

**21.2.1 일반 로그 포맷 (Common Log Format)**

- 가장 일반적인 포맷
- NCAS(일리노이 대학의 국립 수퍼컴퓨팅 활용센터?)가 정의, 
대부분의 상용/오픈소스 서버는 이 포맷을 사용할 수 있다.
- 없는 필드는 - (대시) 로 표현한다.

| 필드 | 설명 |
| --- | --- |
| remotehost | 요청한 컴퓨터의 호스트 명 혹은 IP 주소 |
| username | ident 검색을 수행, 인증된 요청자의 사용자 이름이 있다. |
| auth-username | 인증을 수행했다면, 인증된 요청자의 이름이 있다. |
| timestamp | 요청 날짜와 시간 |
| request-line | HTTP 요청의 행을 그대로 기술한다. |
| response-code | 응답으로 보내는 HTTP 상태코드 |
| response-size | 응답 엔터티의 Content-Length |
| 예시 | 127.0.0.1 user-identifier frank [10/Oct/2000:13:55:36 -0700] "GET /apache_pb.gif HTTP/1.0" 200 2326 |

**21.2.2 혼합 로그 포맷 (Combined Log Format)**

- 아파치같은 서버들이 지원
- 아래 두개 필드 추가된거 빼면 일반 로그 포맷과 동일

| 필드 | 설명 |
| --- | --- |
| Referer | Referer HTTP 헤더의 값 |
| User-Agent | User-Agent Referer HTTP 헤더의 값 |
| 예시 | 127.0.0.1 - frank [10/Oct/2000:13:55:36 -0700] "GET /apache_pb.gif HTTP/1.0" 200 2326 "http://www.example.com/start.html" "Mozilla/4.08 [en] (Win98; I ;Nav)" |

**21.2.3 넥스케이프 확장 로그 포맷** 

- 넷스케이프가 상용 HTTP 애플리케이션이 되면서 프락시, 웹캐시같은 HTTP 애플리케이션과 연관있는 환경을 지원하려고 포맷을 확장했다.
- 일반 로그 포맷 + 넥스케이프 확장 로그 포맷 형식으로 사용

| 필드 | 설명 |
| --- | --- |
| proxy-response-code | 트랜잭션이 프락시를 거칠 경우 서버에서 프락시로의 HTTP 응답코드 |
| proxy-response-size | 트랜잭션이 프락시를 거칠 경우 서버가 프락시에 전달하는 응 답 엔터티의 Content-Length |
| client-request-size | 클라이언트가 프락시로 보내는 요청의 본문이나 엔터티의 Content-Length |
| proxy-request-size | 트랜잭션이 프락시를 거칠 경우 프락시가 서버로 보내는 요청의 본문이나 엔터티의 Content-Length |
| client-request-hdr-size | 클라이언트 요청 헤더의 바이트 길이 |
| proxy-response-hdr-size | 트랜잭션이 프락시를 거칠 경우 프락시가 요청자에게 보내는 응답 헤더의 바이트 길이 |
| proxy-request-hdr-size | 트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 전송하는 요청 헤더의 바이트 길이 |
| server-response-hdr-size | 서버 응답 헤더의 바이트 길이 |
| proxy-timestamp | 트랜잭션이 프락시를 거칠 경우 요청과 응답이 프락시를 통해 오가는 총 시간(초 단위) |

**21.2.4 넥스케이프 확장 2 로그 포맷** 

- 넷스케이프가 프락시, 웹 캐시 관련해서 더 많은 정보를 추가해서 확장 로그 포맷을 만듦
- 일반 로그 포맷 + 넥스케이프 확장 로그 포맷 + 넥스케이프 확장 2 로그 포맷 형식으로 사용

| 필드 | 설명 |
| --- | --- |
| route | 프락시가 클라이언트에 요청을 만드는 데 사용하는 경로 |
| client-finish-status-code | 클라이언트의 종료 상태 코드로 프락시로 보낸 요청이 성공적으로 완료되었는지 혹은 인터럽트에 걸렸는지 기술한다. |
| proxy-finish-status-code | 프락시의 종료 상태 코드로 프락시가 서버로 보낸 요청이 성공적으로 완료되었는지 혹은 인터럽트에 걸렸는지 기술한다. |
| cache-result-code | 캐시 결과 코드로 캐시가 요청에 어떻게 응답했는지 기술한다. |

**21.2.5 스퀴드 프락시 로그 포맷** 

- 스쿼드 프락시 캐시 ([http://www.squid-cache.org/](http://www.squid-cache.org/)) 라는 웹 분야에서 권위있는 프로젝트에서 만든 포맷
- 많은 차세대 프락시 캐시들이 스퀴드 애플리케이션을 관리하는데 도움이 되는 도구들을 활용하려고 이 로그 포맷을 사용했다.

| 필드 | 설명 |
| --- | --- |
| timestamp | 요청이 도착한 시간을 GMT 1970년 1월 1일을 기준으로 지난 시간을 초 단위로 기술 |
| time-elapsed | 요청과 응답이 프락시를 통해 오고간 총 시간을 밀리초로 기술 |
| host-ip | 클라이언트의 호스트 장비 IP 주소 |
| result-code/status | result 필드에는 이 요청에 프락시가 어떤 일을 했는지 스퀴드 방식으로 기술, code 필드는 프락시가 클라이언트에 보낸 HTTP 응답 코드 |
| size | 프락시가 클라이언트에게 보낸 HTTP 응답 헤더와 본문을 포함한 응답의 길이가 바이트 단위로 기술 |
| method | 클라이언트 요청의 HTTP 메서드 |
| url | 클라이언트 요청의 URL |
| rfc931-ident | 클라이언트에 인증된 사용자 이름 |
| hierarchy/from | hierarchy 필드는 프락시가 클라이언트로 요청을 보내면서 거친 경로, from 필드는 프락시가 요청을 만들게 한 서버의 이름을 기술 |
| content-type | 프락시 응답 엔터티의 Content-Type |

### 21.3 적중 개량하기

- 컨텐츠 제공자는 각 URL에 사람들이 얼마나 자주 접근하는지 알아야하고, 광고주는 광고가 얼마나 자주 노출되는지 알아야 한다. 
이런것들을 알기 위해 로깅을 해야한다.
- 하지만, 클라이언트와 서버 사이에 캐시가 있어서 많은 요청이 서버에 오지 않고 캐시에서 끝난다.
서버에서 로깅을 하면 캐시에서 끝나는 요청들을 확인할 수가 없다.
- 적중 개량 (Hit Metering) 규약은 HTTP의 확장으로, 위와같은 문제를 해결하기 위해 캐시가 정기적으로 캐시 접근 통계를 원 서버에 보고하는 것이다.

**21.3.1 개요**

적중 계량 규약은 캐시와 서버가 접근 정보를 공유하고, 사용할 수 있는 캐시 리소스의 양을 제어할 수 있는 몇 가지 기초적인 기능에 관한 HTTP 확장을 정의한다.

적중 계량은 널리 구현되거나 사용되는 규약은 아니다.

**21.3.2 Meter 헤더**

- Meter헤더를 설정해서 캐시의 사용량을 보내준다.

![Untitled](21%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B5%E1%86%BC%E1%84%80%E1%85%AA%20%E1%84%89%E1%85%A1%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%8E%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%A8%20482813e79e8e4dc79dd0eb39cf54aa35/Untitled.png)

![Untitled](21%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B5%E1%86%BC%E1%84%80%E1%85%AA%20%E1%84%89%E1%85%A1%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%8E%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%A8%20482813e79e8e4dc79dd0eb39cf54aa35/Untitled%201.png)

### 21.4 개인정보 보호에 대해

로깅 정보가 사용자에 대한 많은 정보를 가지고 있기 때문에 
로깅이 사생활 침해가 될 수 있다는 것을 유념하고 개인 정보를 보호하기 위해 노력해야 한다.